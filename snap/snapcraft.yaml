# snapcraft.yaml - builds a Snap package of OpenJFX
# Copyright (C) 2020-2021 John Neffenger
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

name: openjfx
title: OpenJFX
summary: Current JavaFX release and early-access builds
description: |
  OpenJFX is the official open-source project that develops JavaFX,
  a cross-platform application framework for developing and deploying
  rich client applications that operate consistently across a diverse
  set of platforms.

  This package, together with OpenJDK 11 or later, provides everything
  you need to develop a JavaFX application on Linux, including all
  of the latest JAR files, native libraries, JMOD archives, API
  documentation, and source code of JavaFX.

  To get started, see the README file for this package on GitHub:

  https://github.com/jgneff/openjfx

  Java and OpenJDK are trademarks or registered trademarks of Oracle
  and/or its affiliates.

version: '17+17'
license: (GPL-2.0 WITH Classpath-exception-2.0)

base: core18
grade: devel
confinement: strict

architectures:
- build-on: amd64

slots:
  javafx-17-1804:
    interface: content
    source:
      read: [$SNAP/jmods, $SNAP/sdk]

apps:
  openjfx:
    command: bin/openjfx.sh
    environment:
      LC_ALL: C.UTF-8

parts:
  bin:
    plugin: dump
    source: .
    source-type: local
    stage: [bin]

  jfx:
    plugin: nil
    source: https://github.com/openjdk/jfx.git
    source-branch: $SNAPCRAFT_PROJECT_VERSION
    source-depth: 1
    build-packages:
    - default-jdk-headless
    - default-jdk-doc
    - pkg-config
    - libgtk2.0-dev
    - libxtst-dev
    - libgtk-3-dev
    - libxxf86vm-dev
    build-environment:
    - JAVA_HOME: /usr/lib/jvm/default-java
    - JDK_DOCS: file:///usr/lib/jvm/default-java/docs/api
    override-build: |
      getproxy () {
          host=$(echo "$1" | sed -E 's|https?://([^:/]*):?[0-9]*/?|\1|')
          port=$(echo "$1" | sed -E 's|https?://[^:/]*:?([0-9]*)/?|\1|')
      }
      # Build the Gradle command using the shell's positional parameters
      set -- bash gradlew
      if [ -n "${http_proxy:-}" ]; then
          getproxy "$http_proxy"
          set -- "$@" "-Dhttp.proxyHost=$host" "-Dhttp.proxyPort=$port"
      fi
      if [ -n "${https_proxy:-}" ]; then
          getproxy "$https_proxy"
          set -- "$@" "-Dhttps.proxyHost=$host" "-Dhttps.proxyPort=$port"
      fi
      "$@" -PPROMOTED_BUILD_NUMBER="${SNAPCRAFT_PROJECT_VERSION#*+}" \
          -PRELEASE_SUFFIX="-ea" -PJDK_DOCS="$JDK_DOCS" sdk jmods javadoc
      cd build || exit
      mv sdk jmods javadoc "$SNAPCRAFT_PART_INSTALL"
      cd "$SNAPCRAFT_PART_INSTALL" || exit
      mkdir -p sdk/src
      cd sdk/src || exit
      "$JAVA_HOME/bin/jar" -xf ../src.zip
    organize:
      javadoc: sdk/api
